name: Update Sports Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        run: |
          cd server
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm ci
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          echo "üìã –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:"
          npm list --depth=0
        continue-on-error: false
      
      - name: Parse and save data
        id: parse
        run: |
          cd server
          echo "üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞..."
          node scripts/parse-and-save-to-github.js
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
        continue-on-error: true
      
      - name: Check results
        if: steps.parse.outcome == 'success' || steps.parse.outcome == 'failure'
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
          if [ -d "data" ]; then
            echo "‚úÖ –ü–∞–ø–∫–∞ data —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            ls -la data/
            if [ -f "data/predictions.json" ]; then
              echo "‚úÖ predictions.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              echo "–†–∞–∑–º–µ—Ä: $(wc -c < data/predictions.json) bytes"
            else
              echo "‚ùå predictions.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            if [ -f "data/news.json" ]; then
              echo "‚úÖ news.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              echo "–†–∞–∑–º–µ—Ä: $(wc -c < data/news.json) bytes"
            else
              echo "‚ùå news.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            if [ -f "data/metadata.json" ]; then
              echo "‚úÖ metadata.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              cat data/metadata.json
            else
              echo "‚ùå metadata.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
          else
            echo "‚ùå –ü–∞–ø–∫–∞ data –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          fi
      
      - name: Commit and push changes
        if: steps.parse.outcome == 'success' || steps.parse.outcome == 'failure'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
          if [ -f data/predictions.json ] || [ -f data/news.json ] || [ -f data/metadata.json ]; then
            git add data/*.json
            
            if ! git diff --staged --quiet; then
              git commit -m "ü§ñ Auto-update data: $(date +'%Y-%m-%d %H:%M:%S UTC')"
              git push
              echo "‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
            else
              echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            fi
          else
            echo "‚ö†Ô∏è –§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.parse.outcome }}" == "success" ]; then
            echo "- ‚úÖ Workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ" >> $GITHUB_STEP_SUMMARY
            echo "- üìÅ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫—É \`data/\`" >> $GITHUB_STEP_SUMMARY
            echo "- üåê –î–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ raw.githubusercontent.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ workflow" >> $GITHUB_STEP_SUMMARY
            echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π" >> $GITHUB_STEP_SUMMARY
            echo "- –°—Ç–∞—Ç—É—Å: ${{ steps.parse.outcome }}" >> $GITHUB_STEP_SUMMARY
          fi
